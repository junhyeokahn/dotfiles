name: Test install scripts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Detect which files changed to determine which tests to run
  changes:
    runs-on: ubuntu-latest
    outputs:
      nvim: ${{ steps.filter.outputs.nvim }}
      prerequisite: ${{ steps.filter.outputs.prerequisite }}
      kitty: ${{ steps.filter.outputs.kitty }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          nvim:
            - 'install-nvim-nix.sh'
            - 'nvim-nix/**'
            - '.github/workflows/test-install-scripts.yml'
          prerequisite:
            - 'install-prerequisite.sh'
            - '.github/workflows/test-install-scripts.yml'
          kitty:
            - 'install-kitty.sh'
            - 'kitty.conf'
            - 'starship.toml'
            - 'zoom_toggle.py'
            - 'custom-hints.py'
            - 'current-theme.conf'
            - '.github/workflows/test-install-scripts.yml'

  test-nvim-install:
    needs: changes
    if: needs.changes.outputs.nvim == 'true' || github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 📦 Run nvim-nix install script
      run: |
        chmod +x ./install-nvim-nix.sh
        # Set GitHub token for Nix to avoid rate limiting
        export NIX_CONFIG="access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
        ./install-nvim-nix.sh

    - name: ✅ Verify nvim installation
      run: |
        echo "═══════════════════════════════════════════════════════"
        echo "  🔍 Verifying Neovim Installation"
        echo "═══════════════════════════════════════════════════════"
        # Source nix environment
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi
        export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/nix/profile/bin:$PATH"

        # Check nvim is available
        echo "📍 Checking nvim location..."
        which nvim
        echo ""
        echo "📋 Neovim version:"
        nvim --version | head -5

    - name: 📁 Verify config files
      run: |
        echo "═══════════════════════════════════════════════════════"
        echo "  🔍 Verifying Configuration Files"
        echo "═══════════════════════════════════════════════════════"
        # Check that config files were downloaded
        echo "📂 Checking configuration directory: ~/.config/nvim-nix/"
        [ -f "$HOME/.config/nvim-nix/init.lua" ] || (echo "❌ init.lua not found" && exit 1)
        echo "  ✅ init.lua found"
        [ -d "$HOME/.config/nvim-nix/lua" ] || (echo "❌ lua directory not found" && exit 1)
        echo "  ✅ lua/ directory found"
        echo ""
        echo "📋 Configuration files:"
        ls -la "$HOME/.config/nvim-nix/"

    - name: 🚀 Test nvim startup and colorscheme
      run: |
        # Source nix environment
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi
        export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/nix/profile/bin:$PATH"

        echo "═══════════════════════════════════════════════════════"
        echo "  🧪 Testing Neovim Startup"
        echo "═══════════════════════════════════════════════════════"

        # Test that nvim can start and exit cleanly
        echo "🔄 Starting Neovim in headless mode..."
        nvim --headless -c 'echo "Neovim started successfully"' -c 'qa!' || exit 1
        echo "✅ Neovim startup test passed"

        echo ""
        echo "🎨 Checking colorscheme..."
        COLORSCHEME=$(nvim --headless -c 'colorscheme' -c 'qa!' 2>&1 | tail -1)
        if [[ "$COLORSCHEME" == *"kanagawa"* ]]; then
          echo "  ✅ Colorscheme: kanagawa"
        else
          echo "  ❌ Expected 'kanagawa' but got: $COLORSCHEME"
          exit 1
        fi
        echo ""
        echo "═══════════════════════════════════════════════════════"
        echo "  ✅ All Neovim tests passed!"
        echo "═══════════════════════════════════════════════════════"

  test-prerequisite-install:
    needs: changes
    if: needs.changes.outputs.prerequisite == 'true' || github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 🔧 Run prerequisite install script
      run: |
        chmod +x ./install-prerequisite.sh
        ./install-prerequisite.sh

    - name: 🔍 Verify fzf installation
      run: |
        echo "═══════════════════════════════════════════════════════"
        echo "  🎯 Verifying FZF Installation"
        echo "═══════════════════════════════════════════════════════"
        # Add fzf to PATH (it's installed in ~/.fzf/bin)
        export PATH="$HOME/.fzf/bin:$PATH"

        # Check fzf is available
        echo "📍 Checking fzf location..."
        which fzf || (echo "❌ fzf not found" && exit 1)
        echo "✅ FZF found at: $(which fzf)"
        echo ""
        echo "📋 FZF version:"
        fzf --version
        echo "✅ FZF installed successfully"

    - name: 🔧 Verify other tools installation
      run: |
        echo "═══════════════════════════════════════════════════════"
        echo "  📦 Verifying Prerequisite Tools"
        echo "═══════════════════════════════════════════════════════"
        echo "📦 Checking Git..."
        which git || (echo "❌ git not found" && exit 1)
        echo "  ✅ $(git --version)"

        echo ""
        echo "🔍 Checking Ripgrep..."
        which rg || (echo "❌ ripgrep not found" && exit 1)
        echo "  ✅ $(rg --version | head -1)"

        echo ""
        echo "🌐 Checking Curl..."
        which curl || (echo "❌ curl not found" && exit 1)
        echo "  ✅ $(curl --version | head -1)"

        echo ""
        echo "═══════════════════════════════════════════════════════"
        echo "  ✅ All prerequisite tools verified!"
        echo "═══════════════════════════════════════════════════════"

  test-kitty-install:
    needs: changes
    if: needs.changes.outputs.kitty == 'true' || github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 🍺 Install Homebrew (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Homebrew is pre-installed on GitHub Actions macOS runners
        brew --version

    - name: 📝 Create required config files for testing
      run: |
        # Create dummy config files that the script expects to copy
        touch kitty.conf
        touch zoom_toggle.py
        touch custom-hints.py
        touch current-theme.conf
        touch starship.toml

    - name: 🐱 Run kitty install script
      run: |
        chmod +x ./install-kitty.sh
        # Run the install script - it may fail on font installation due to sudo requirements
        ./install-kitty.sh || echo "Script failed with code $?, checking if kitty was at least partially installed"

    - name: ✅ Verify Kitty installation
      run: |
        echo "══════════════════════════════════════════════════════"
        echo "  🐱 Verifying Kitty Terminal"
        echo "══════════════════════════════════════════════════════"
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # Check if Kitty.app exists
          if [ -d ~/Applications/kitty.app ]; then
            KITTY_BIN=~/Applications/kitty.app/Contents/MacOS/kitty
          elif [ -d /Applications/kitty.app ]; then
            KITTY_BIN=/Applications/kitty.app/Contents/MacOS/kitty
          else
            echo "Kitty.app not found" && exit 1
          fi
          echo "✅ Kitty.app found at $(dirname $(dirname $KITTY_BIN))"

          # Test kitty executable
          echo "📋 Version: $($KITTY_BIN --version 2>&1 | head -1)" || (echo "❌ Failed to run kitty --version" && exit 1)
        else
          # Check if kitty binary exists
          [ -f ~/.local/kitty.app/bin/kitty ] || (echo "kitty binary not found" && exit 1)

          # Test kitty executable
          echo "📋 Version: $(~/.local/kitty.app/bin/kitty --version 2>&1 | head -1)" || (echo "❌ Failed to run kitty --version" && exit 1)
        fi
        echo "✅ Kitty installed and working"

    - name: 🌟 Verify Starship installation
      run: |
        echo "══════════════════════════════════════════════════════"
        echo "  🌟 Verifying Starship Prompt"
        echo "══════════════════════════════════════════════════════"
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # Source brew environment
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          which starship || (echo "❌ starship not found" && exit 1)
          echo "📋 Version: $(starship --version 2>&1 | head -1)"
        else
          # Check if starship was installed
          which starship || [ -f /usr/local/bin/starship ] || (echo "❌ starship not found" && exit 1)
          echo "📋 Version: $((which starship && starship --version) || /usr/local/bin/starship --version 2>&1 | head -1)"
        fi
        echo "✅ Starship installed successfully"

    - name: 📁 Verify Kitty config files
      run: |
        echo "══════════════════════════════════════════════════════"
        echo "  📂 Verifying Configuration Files"
        echo "══════════════════════════════════════════════════════"
        echo "📂 Checking Kitty config directory..."
        [ -f "$HOME/.config/kitty/kitty.conf" ] || (echo "❌ kitty.conf not found" && exit 1)
        echo "  ✅ kitty.conf"
        [ -f "$HOME/.config/kitty/zoom_toggle.py" ] || (echo "❌ zoom_toggle.py not found" && exit 1)
        echo "  ✅ zoom_toggle.py"
        [ -f "$HOME/.config/kitty/custom-hints.py" ] || (echo "❌ custom-hints.py not found" && exit 1)
        echo "  ✅ custom-hints.py"
        [ -f "$HOME/.config/kitty/current-theme.conf" ] || (echo "❌ current-theme.conf not found" && exit 1)
        echo "  ✅ current-theme.conf"
        echo ""
        echo "🌟 Checking Starship config..."
        [ -f "$HOME/.config/starship.toml" ] || (echo "❌ starship.toml not found" && exit 1)
        echo "  ✅ starship.toml"
        echo ""
        echo "📋 Directory contents:"
        ls -la "$HOME/.config/kitty/"

    - name: 🅰️ Verify font installation
      run: |
        echo "══════════════════════════════════════════════════════"
        echo "  🅰️ Verifying Font Installation"
        echo "══════════════════════════════════════════════════════"
        FONT_FOUND=0
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # On macOS, check if fonts are installed
          echo "🔍 Looking for JetBrainsMono fonts..."
          if ls /Library/Fonts/JetBrainsMono* 2>/dev/null || ls ~/Library/Fonts/JetBrainsMono* 2>/dev/null; then
            FONT_FOUND=1
            echo "  ✅ JetBrainsMono fonts found"
          fi
        else
          # On Linux, check if fonts are installed
          echo "🔍 Looking for JetBrainsMono fonts..."
          if ls /usr/share/fonts/JetBrainsMono* 2>/dev/null; then
            FONT_FOUND=1
            echo "  ✅ JetBrainsMono fonts found in /usr/share/fonts"
          fi

          # Also check font cache
          if [ $FONT_FOUND -eq 0 ]; then
            echo "🗄️ Checking font cache..."
            if fc-list | grep -i jetbrains > /dev/null; then
              FONT_FOUND=1
              echo "  ✅ JetBrainsMono found in font cache"
            fi
          fi
        fi

        if [ $FONT_FOUND -eq 0 ]; then
          echo "  ❌ JetBrainsMono fonts not installed"
          exit 1
        fi
        echo ""
        echo "══════════════════════════════════════════════════════"
        echo "  ✅ All Kitty tests passed!"
        echo "══════════════════════════════════════════════════════"

  # Summary job that branch protection can depend on
  # This job always runs and succeeds if all relevant tests pass
  tests-complete:
    name: All Tests Complete
    runs-on: ubuntu-latest
    needs: [changes, test-nvim-install, test-prerequisite-install, test-kitty-install]
    if: always()
    steps:
    - name: Check test results
      run: |
        echo "Checking test results..."

        # Check if any required test failed
        if [[ "${{ needs.test-nvim-install.result }}" == "failure" ]] || \
           [[ "${{ needs.test-prerequisite-install.result }}" == "failure" ]] || \
           [[ "${{ needs.test-kitty-install.result }}" == "failure" ]]; then
          echo "❌ One or more tests failed"
          exit 1
        fi

        echo "✅ All required tests passed or were skipped appropriately"