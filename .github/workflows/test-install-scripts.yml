name: Test install scripts

on:
  push:
    branches: [ main ]
    paths:
      - 'install-*.sh'
      - 'nvim-nix/**'
      - '.github/workflows/test-install-scripts.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'install-*.sh'
      - 'nvim-nix/**'
      - '.github/workflows/test-install-scripts.yml'
  workflow_dispatch:

jobs:
  test-nvim-install:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run install script
      run: |
        chmod +x ./install-nvim-nix.sh
        # Set GitHub token for Nix to avoid rate limiting
        export NIX_CONFIG="access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
        ./install-nvim-nix.sh

    - name: Verify nvim installation
      run: |
        # Source nix environment
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi
        export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/nix/profile/bin:$PATH"

        # Check nvim is available
        which nvim
        nvim --version

    - name: Verify config files
      run: |
        # Check that config files were downloaded
        [ -f "$HOME/.config/nvim-nix/init.lua" ] || (echo "init.lua not found" && exit 1)
        [ -d "$HOME/.config/nvim-nix/lua" ] || (echo "lua directory not found" && exit 1)
        echo "Config files successfully downloaded"
        ls -la "$HOME/.config/nvim-nix/"

    - name: Test nvim startup and colorscheme
      run: |
        # Source nix environment
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi
        export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/nix/profile/bin:$PATH"

        # Test that nvim can start and exit cleanly
        nvim --headless -c 'echo "Neovim started successfully"' -c 'qa!' || exit 1
        echo "Neovim startup test passed"

        # Check colorscheme is kanagawa
        COLORSCHEME=$(nvim --headless -c 'colorscheme' -c 'qa!' 2>&1 | tail -1)
        echo "Current colorscheme: $COLORSCHEME"
        if [[ "$COLORSCHEME" == *"kanagawa"* ]]; then
          echo "✓ Colorscheme is correctly set to kanagawa"
        else
          echo "✗ Expected colorscheme 'kanagawa' but got: $COLORSCHEME"
          exit 1
        fi

  test-prerequisite-install:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run prerequisite install script
      run: |
        chmod +x ./install-prerequisite.sh
        ./install-prerequisite.sh

    - name: Verify fzf installation
      run: |
        # Add fzf to PATH (it's installed in ~/.fzf/bin)
        export PATH="$HOME/.fzf/bin:$PATH"

        # Check fzf is available
        which fzf || (echo "fzf not found" && exit 1)
        fzf --version
        echo "fzf installed successfully"

    - name: Verify other tools installation
      run: |
        # Check git
        which git || (echo "git not found" && exit 1)
        git --version

        # Check ripgrep
        which rg || (echo "ripgrep not found" && exit 1)
        rg --version

        # Check curl
        which curl || (echo "curl not found" && exit 1)
        curl --version

        echo "All prerequisite tools installed successfully"

  test-kitty-install:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Homebrew (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Homebrew is pre-installed on GitHub Actions macOS runners
        brew --version

    - name: Create required config files for testing
      run: |
        # Create dummy config files that the script expects to copy
        touch kitty.conf
        touch zoom_toggle.py
        touch custom-hints.py
        touch current-theme.conf
        touch starship.toml

    - name: Run kitty install script
      run: |
        chmod +x ./install-kitty.sh
        # Run the install script - it may fail on font installation due to sudo requirements
        ./install-kitty.sh || echo "Script failed with code $?, checking if kitty was at least partially installed"

    - name: Verify Kitty installation
      run: |
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # Check if Kitty.app exists
          if [ -d ~/Applications/kitty.app ]; then
            KITTY_BIN=~/Applications/kitty.app/Contents/MacOS/kitty
          elif [ -d /Applications/kitty.app ]; then
            KITTY_BIN=/Applications/kitty.app/Contents/MacOS/kitty
          else
            echo "Kitty.app not found" && exit 1
          fi
          echo "Kitty.app found at $(dirname $(dirname $KITTY_BIN))"

          # Test kitty executable
          $KITTY_BIN --version || (echo "Failed to run kitty --version" && exit 1)
        else
          # Check if kitty binary exists
          [ -f ~/.local/kitty.app/bin/kitty ] || (echo "kitty binary not found" && exit 1)

          # Test kitty executable
          ~/.local/kitty.app/bin/kitty --version || (echo "Failed to run kitty --version" && exit 1)
        fi
        echo "✓ Kitty installed and working"

    - name: Verify Starship installation
      run: |
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # Source brew environment
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          which starship || (echo "starship not found" && exit 1)
          starship --version
        else
          # Check if starship was installed
          which starship || [ -f /usr/local/bin/starship ] || (echo "starship not found" && exit 1)
          (which starship && starship --version) || /usr/local/bin/starship --version
        fi
        echo "Starship installed successfully"

    - name: Verify Kitty config files
      run: |
        # Check that config files were copied
        [ -f "$HOME/.config/kitty/kitty.conf" ] || (echo "kitty.conf not found" && exit 1)
        [ -f "$HOME/.config/kitty/zoom_toggle.py" ] || (echo "zoom_toggle.py not found" && exit 1)
        [ -f "$HOME/.config/kitty/custom-hints.py" ] || (echo "custom-hints.py not found" && exit 1)
        [ -f "$HOME/.config/kitty/current-theme.conf" ] || (echo "current-theme.conf not found" && exit 1)
        [ -f "$HOME/.config/starship.toml" ] || (echo "starship.toml not found" && exit 1)
        echo "All config files copied successfully"
        ls -la "$HOME/.config/kitty/"

    - name: Verify font installation
      run: |
        FONT_FOUND=0
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # On macOS, check if fonts are installed
          echo "Looking for JetBrainsMono fonts..."
          if ls /Library/Fonts/JetBrainsMono* 2>/dev/null || ls ~/Library/Fonts/JetBrainsMono* 2>/dev/null; then
            FONT_FOUND=1
            echo "✓ JetBrainsMono fonts found"
          fi
        else
          # On Linux, check if fonts are installed
          echo "Looking for JetBrainsMono fonts..."
          if ls /usr/share/fonts/JetBrainsMono* 2>/dev/null; then
            FONT_FOUND=1
            echo "✓ JetBrainsMono fonts found in /usr/share/fonts"
          fi

          # Also check font cache
          if [ $FONT_FOUND -eq 0 ]; then
            echo "Checking font cache..."
            if fc-list | grep -i jetbrains > /dev/null; then
              FONT_FOUND=1
              echo "✓ JetBrainsMono found in font cache"
            fi
          fi
        fi

        if [ $FONT_FOUND -eq 0 ]; then
          echo "✗ JetBrainsMono fonts not installed"
          exit 1
        fi
