name: Test install scripts

on:
  push:
    branches: [ main ]
    paths:
      - 'install-*.sh'
      - 'nvim-nix/**'
      - '.github/workflows/test-install-scripts.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'install-*.sh'
      - 'nvim-nix/**'
      - '.github/workflows/test-install-scripts.yml'
  workflow_dispatch:

jobs:
  test-nvim-install:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Run nvim-nix install script
      run: |
        chmod +x ./install-nvim-nix.sh
        # Set GitHub token for Nix to avoid rate limiting
        export NIX_CONFIG="access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}"
        ./install-nvim-nix.sh

    - name: âœ… Verify nvim installation
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ” Verifying Neovim Installation"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        # Source nix environment
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi
        export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/nix/profile/bin:$PATH"

        # Check nvim is available
        echo "ğŸ“ Checking nvim location..."
        which nvim
        echo ""
        echo "ğŸ“‹ Neovim version:"
        nvim --version | head -5

    - name: ğŸ“ Verify config files
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ” Verifying Configuration Files"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        # Check that config files were downloaded
        echo "ğŸ“‚ Checking configuration directory: ~/.config/nvim-nix/"
        [ -f "$HOME/.config/nvim-nix/init.lua" ] || (echo "âŒ init.lua not found" && exit 1)
        echo "  âœ… init.lua found"
        [ -d "$HOME/.config/nvim-nix/lua" ] || (echo "âŒ lua directory not found" && exit 1)
        echo "  âœ… lua/ directory found"
        echo ""
        echo "ğŸ“‹ Configuration files:"
        ls -la "$HOME/.config/nvim-nix/"

    - name: ğŸš€ Test nvim startup and colorscheme
      run: |
        # Source nix environment
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
          . "$HOME/.nix-profile/etc/profile.d/nix.sh"
        fi
        export PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin:/nix/profile/bin:$PATH"

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ§ª Testing Neovim Startup"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        # Test that nvim can start and exit cleanly
        echo "ğŸ”„ Starting Neovim in headless mode..."
        nvim --headless -c 'echo "Neovim started successfully"' -c 'qa!' || exit 1
        echo "âœ… Neovim startup test passed"

        echo ""
        echo "ğŸ¨ Checking colorscheme..."
        COLORSCHEME=$(nvim --headless -c 'colorscheme' -c 'qa!' 2>&1 | tail -1)
        if [[ "$COLORSCHEME" == *"kanagawa"* ]]; then
          echo "  âœ… Colorscheme: kanagawa"
        else
          echo "  âŒ Expected 'kanagawa' but got: $COLORSCHEME"
          exit 1
        fi
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ… All Neovim tests passed!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  test-prerequisite-install:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Run prerequisite install script
      run: |
        chmod +x ./install-prerequisite.sh
        ./install-prerequisite.sh

    - name: ğŸ” Verify fzf installation
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ¯ Verifying FZF Installation"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        # Add fzf to PATH (it's installed in ~/.fzf/bin)
        export PATH="$HOME/.fzf/bin:$PATH"

        # Check fzf is available
        echo "ğŸ“ Checking fzf location..."
        which fzf || (echo "âŒ fzf not found" && exit 1)
        echo "âœ… FZF found at: $(which fzf)"
        echo ""
        echo "ğŸ“‹ FZF version:"
        fzf --version
        echo "âœ… FZF installed successfully"

    - name: ğŸ”§ Verify other tools installation
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ“¦ Verifying Prerequisite Tools"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ Checking Git..."
        which git || (echo "âŒ git not found" && exit 1)
        echo "  âœ… $(git --version)"

        echo ""
        echo "ğŸ” Checking Ripgrep..."
        which rg || (echo "âŒ ripgrep not found" && exit 1)
        echo "  âœ… $(rg --version | head -1)"

        echo ""
        echo "ğŸŒ Checking Curl..."
        which curl || (echo "âŒ curl not found" && exit 1)
        echo "  âœ… $(curl --version | head -1)"

        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ… All prerequisite tools verified!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  test-kitty-install:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: ğŸº Install Homebrew (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Homebrew is pre-installed on GitHub Actions macOS runners
        brew --version

    - name: ğŸ“ Create required config files for testing
      run: |
        # Create dummy config files that the script expects to copy
        touch kitty.conf
        touch zoom_toggle.py
        touch custom-hints.py
        touch current-theme.conf
        touch starship.toml

    - name: ğŸ± Run kitty install script
      run: |
        chmod +x ./install-kitty.sh
        # Run the install script - it may fail on font installation due to sudo requirements
        ./install-kitty.sh || echo "Script failed with code $?, checking if kitty was at least partially installed"

    - name: âœ… Verify Kitty installation
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ± Verifying Kitty Terminal"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # Check if Kitty.app exists
          if [ -d ~/Applications/kitty.app ]; then
            KITTY_BIN=~/Applications/kitty.app/Contents/MacOS/kitty
          elif [ -d /Applications/kitty.app ]; then
            KITTY_BIN=/Applications/kitty.app/Contents/MacOS/kitty
          else
            echo "Kitty.app not found" && exit 1
          fi
          echo "âœ… Kitty.app found at $(dirname $(dirname $KITTY_BIN))"

          # Test kitty executable
          echo "ğŸ“‹ Version: $($KITTY_BIN --version 2>&1 | head -1)" || (echo "âŒ Failed to run kitty --version" && exit 1)
        else
          # Check if kitty binary exists
          [ -f ~/.local/kitty.app/bin/kitty ] || (echo "kitty binary not found" && exit 1)

          # Test kitty executable
          echo "ğŸ“‹ Version: $(~/.local/kitty.app/bin/kitty --version 2>&1 | head -1)" || (echo "âŒ Failed to run kitty --version" && exit 1)
        fi
        echo "âœ… Kitty installed and working"

    - name: ğŸŒŸ Verify Starship installation
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸŒŸ Verifying Starship Prompt"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # Source brew environment
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)"
          which starship || (echo "âŒ starship not found" && exit 1)
          echo "ğŸ“‹ Version: $(starship --version 2>&1 | head -1)"
        else
          # Check if starship was installed
          which starship || [ -f /usr/local/bin/starship ] || (echo "âŒ starship not found" && exit 1)
          echo "ğŸ“‹ Version: $((which starship && starship --version) || /usr/local/bin/starship --version 2>&1 | head -1)"
        fi
        echo "âœ… Starship installed successfully"

    - name: ğŸ“ Verify Kitty config files
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ“‚ Verifying Configuration Files"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“‚ Checking Kitty config directory..."
        [ -f "$HOME/.config/kitty/kitty.conf" ] || (echo "âŒ kitty.conf not found" && exit 1)
        echo "  âœ… kitty.conf"
        [ -f "$HOME/.config/kitty/zoom_toggle.py" ] || (echo "âŒ zoom_toggle.py not found" && exit 1)
        echo "  âœ… zoom_toggle.py"
        [ -f "$HOME/.config/kitty/custom-hints.py" ] || (echo "âŒ custom-hints.py not found" && exit 1)
        echo "  âœ… custom-hints.py"
        [ -f "$HOME/.config/kitty/current-theme.conf" ] || (echo "âŒ current-theme.conf not found" && exit 1)
        echo "  âœ… current-theme.conf"
        echo ""
        echo "ğŸŒŸ Checking Starship config..."
        [ -f "$HOME/.config/starship.toml" ] || (echo "âŒ starship.toml not found" && exit 1)
        echo "  âœ… starship.toml"
        echo ""
        echo "ğŸ“‹ Directory contents:"
        ls -la "$HOME/.config/kitty/"

    - name: ğŸ…°ï¸ Verify font installation
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  ğŸ…°ï¸ Verifying Font Installation"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        FONT_FOUND=0
        if [[ "$(uname -s)" == "Darwin" ]]; then
          # On macOS, check if fonts are installed
          echo "ğŸ” Looking for JetBrainsMono fonts..."
          if ls /Library/Fonts/JetBrainsMono* 2>/dev/null || ls ~/Library/Fonts/JetBrainsMono* 2>/dev/null; then
            FONT_FOUND=1
            echo "  âœ… JetBrainsMono fonts found"
          fi
        else
          # On Linux, check if fonts are installed
          echo "ğŸ” Looking for JetBrainsMono fonts..."
          if ls /usr/share/fonts/JetBrainsMono* 2>/dev/null; then
            FONT_FOUND=1
            echo "  âœ… JetBrainsMono fonts found in /usr/share/fonts"
          fi

          # Also check font cache
          if [ $FONT_FOUND -eq 0 ]; then
            echo "ğŸ—„ï¸ Checking font cache..."
            if fc-list | grep -i jetbrains > /dev/null; then
              FONT_FOUND=1
              echo "  âœ… JetBrainsMono found in font cache"
            fi
          fi
        fi

        if [ $FONT_FOUND -eq 0 ]; then
          echo "  âŒ JetBrainsMono fonts not installed"
          exit 1
        fi
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  âœ… All Kitty tests passed!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
